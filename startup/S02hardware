#!/bin/sh

debug=0

start()
{
  for arg in `sed -e 's/ $//; y/ /\n/' /proc/cmdline`; do
    case "$arg" in
      blacklist=*)
        # build user blacklist
        for mod in `echo ${arg#blacklist=} | tr ',' ' '`; do
	  echo "blacklist $mod" >>/etc/modprobe.d/user-blacklist
	done;;
      extramodules=*)
        extramodules=`echo ${arg#extramodules=} | tr ',' ' '`;;
    esac
  done

  mount -t ramfs udev /dev
  mkdir -p /dev/pts
  mount -t devpts none /dev/pts                     

  # create essential initial devices
  mknod -m 666 /dev/null c 1 3
  mknod -m 666 /dev/zero c 1 5
  mknod -m 600 /dev/console c 5 1

  echo "Detecting hardware"
  udevd --daemon
  udevtrigger
  udevsettle --timeout=20

  # load extra modules from command line
  for mod in $extramodules; do
    echo "Loading module: $mod"
    modprobe $mod
  done

  # need dm-mod for P2V:
  modprobe dm-mod

  return 0
}

stop()
{
  killall udevd
  umount /dev
  return 0
}


RET=0
case "$1" in
  start)
    start
    RET=$?;;
  stop)
    stop
    RET=$?;;
  *)
    echo "Usage: $0 start|stop"
    RET=1
esac

exit $RET
